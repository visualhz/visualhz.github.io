(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{316:function(a,s,t){"use strict";t.r(s);var e=t(4),r=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h2",{attrs:{id:"_1-vsphere配置gpu直通"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-vsphere配置gpu直通"}},[a._v("#")]),a._v(" 1.vSphere配置gpu直通")]),a._v(" "),s("p",[a._v("在vSphere中配置显卡直通，ESXI机器将需要进入维护模式并重新引导")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2023/04/04/ko6F7YzJhy2Guj4.png",alt:"image-20210601153252871"}})]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"_2-虚拟机配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-虚拟机配置"}},[a._v("#")]),a._v(" 2.虚拟机配置")]),a._v(" "),s("p",[a._v("配置虚拟机前，请先查看GPU兼容性列表（"),s("a",{attrs:{href:"https://www.vmware.com/resources/compatibility/search.php?deviceCategory=sptg",target:"_blank",rel:"noopener noreferrer"}},[a._v("GPU直通兼容性查询"),s("OutboundLink")],1),a._v("）")]),a._v(" "),s("p",[a._v("创建虚拟机，系统选择为centos7，其中"),s("strong",[a._v("最小内存为GPU显存总大小的1.5倍")]),a._v("(如此处使用GPU为P100，其显存为16GB，则最小内存大小为24GB)")]),a._v(" "),s("p",[a._v("添加新PCI设备，并选择gpu设备进行添加，注意勾选"),s("strong",[a._v("预留所有客户机内存(全部锁定)")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2023/04/04/b9aJefK87TPNpuI.png",alt:"image-20210601153545092"}})]),a._v(" "),s("p",[a._v("依据"),s("a",{attrs:{href:"https://docs.vmware.com/cn/VMware-vSphere-Bitfusion/3.0/Install-Guide/GUID-2005A8C6-4FDC-46DF-BB6B-989F6E91F3E2.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("官方文档"),s("OutboundLink")],1),a._v("：")]),a._v(" "),s("ul",[s("li",[a._v("如果 GPU 需要 16 GB 或更多的内存映射，请在 ESXi 主机的 BIOS 设置中为 GPU 启用直通（通常情况下，设置的名称为 Above 4G decoding、Memory mapped I/O above 4GB 或 PCI 64-bit resource handing above 4G）")]),a._v(" "),s("li",[a._v("在虚拟机的引导选项中启用 UEFI 或 EFI")])]),a._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2023/04/04/ku4KT7VpFrhafWe.png",alt:"image-20210601155502259"}})]),a._v(" "),s("p",[a._v("在高级设置中为虚拟机添加参数：")]),a._v(" "),s("ul",[s("li",[s("p",[s("code",[a._v("hypervisor.cpuid.v0 = FALSE")]),a._v("（不添加此参数可能会导致驱动安装后找不到显卡）")])]),a._v(" "),s("li",[s("p",[s("code",[a._v("pciPassthru.use64bitMMIO = TRUE")]),a._v("（不添加此参数可能导致虚拟机无法开机或开机黑屏）")])]),a._v(" "),s("li",[s("p",[s("code",[a._v("pciPassthru.64bitMMIOSizeGB = 48")]),a._v("（以P100为例，此处应当填写16即可）")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2023/04/04/LBH76MmNJtR5kDu.png",alt:"image-20210601162211405"}})])])]),a._v(" "),s("p",[a._v("其中"),s("code",[a._v("pciPassthru.64bitMMIOSizeGB")]),a._v("的数值取决于GPU显存的总和，具体来说")]),a._v(" "),s("ul",[s("li",[a._v("两个16G显存GPU，2 x 16 GB = 32，将 32 GB 向上舍入到下一个 2 次幂，则数值应当为 64 GB")]),a._v(" "),s("li",[a._v("三个16G显存GPU，3 x 16 GB = 48，将 48 GB 向上舍入到下一个 2 次幂，则数值应当为 64 GB")])]),a._v(" "),s("p",[a._v("虚拟机开机后，正常进行系统的安装，此处安装为centos7（gnome）")]),a._v(" "),s("hr"),a._v(" "),s("h2",{attrs:{id:"_3-驱动安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-驱动安装"}},[a._v("#")]),a._v(" 3.驱动安装")]),a._v(" "),s("h3",{attrs:{id:"_3-1确认gpu设备存在"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1确认gpu设备存在"}},[a._v("#")]),a._v(" 3.1确认gpu设备存在")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("lspci "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-i")]),a._v(" nvidia\n")])])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2023/04/04/kEpldyOi2V1Bfoz.png",alt:"image-20210601162926014"}})]),a._v(" "),s("h3",{attrs:{id:"_3-2配置yum镜像源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2配置yum镜像源"}},[a._v("#")]),a._v(" 3.2配置yum镜像源")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("wget")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-O")]),a._v(" /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\nyum clean all\nyum makecache\n")])])]),s("h3",{attrs:{id:"_3-3依赖环境安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3依赖环境安装"}},[a._v("#")]),a._v(" 3.3依赖环境安装")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("yum "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" kernel-devel gcc "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v("\n")])])]),s("h3",{attrs:{id:"_3-4检查内核版本和源码版本是否一致"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4检查内核版本和源码版本是否一致"}},[a._v("#")]),a._v(" 3.4检查内核版本和源码版本是否一致")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v(" /boot "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" vmlinu\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rpm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-aq")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" kernel-devel\n")])])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2023/04/04/ZFryT6mUdnbsNXw.png",alt:"image-20210601163415060"}})]),a._v(" "),s("h3",{attrs:{id:"_3-5屏蔽系统自带的nouveau"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-5屏蔽系统自带的nouveau"}},[a._v("#")]),a._v(" 3.5屏蔽系统自带的nouveau")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("vim")]),a._v(" /lib/modprobe.d/dist-blacklist.conf\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 注释nvidiafb:")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#blacklist nvidiafb")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 并添加语句：")]),a._v("\nblacklist nouveau\noptions nouveau "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("modeset")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2023/04/04/oEIskcHXzauG3ep.png",alt:"image-20210601163554291"}})]),a._v(" "),s("h3",{attrs:{id:"_3-6重建initramfs-image"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-6重建initramfs-image"}},[a._v("#")]),a._v(" 3.6重建initramfs image")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mv")]),a._v(" /boot/initramfs-"),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(".img /boot/initramfs-"),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(".img.bak\ndracut /boot/initramfs-"),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v(".img "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n")])])]),s("h3",{attrs:{id:"_3-7验证准备完成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-7验证准备完成"}},[a._v("#")]),a._v(" 3.7验证准备完成")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#修改运行级别为文本模式")]),a._v("\nsystemctl set-default multi-user.target\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#重新启动")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("reboot")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#验证是否已屏蔽系统驱动")]),a._v("\nlsmod "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" nouveau\n")])])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2023/04/04/DCqJjV7uOzIG3T6.png",alt:"image-20210601164107618"}})]),a._v(" "),s("h3",{attrs:{id:"_3-8nvidia官网下载驱动"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-8nvidia官网下载驱动"}},[a._v("#")]),a._v(" 3.8nvidia官网下载驱动")]),a._v(" "),s("p",[s("a",{attrs:{href:"https://www.nvidia.cn/Download/index.aspx?lang=cn",target:"_blank",rel:"noopener noreferrer"}},[a._v("NVIDIA驱动程序下载"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2023/04/04/JnBdGukI2pCDW3F.png",alt:"image-20210601164239105"}})]),a._v(" "),s("h3",{attrs:{id:"_3-9安装驱动"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-9安装驱动"}},[a._v("#")]),a._v(" 3.9安装驱动")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" +x NVIDIA-Linux-x86_64-460.73.01.run\n./NVIDIA-Linux-x86_64-460.73.01.run --kernel-source-path"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/usr/src/kernels/3.10.0-1160.25.1.el7.x86_64/ --no-opengl-files "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-k")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n")])])]),s("p",[s("strong",[a._v("注意安装过程中提示是否修改X config，选择否")]),a._v("（选择是将会导致桌面无法显示）")]),a._v(" "),s("h3",{attrs:{id:"_3-10验证安装成功"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-10验证安装成功"}},[a._v("#")]),a._v(" 3.10验证安装成功")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("nvidia-smi\n")])])]),s("p",[s("img",{attrs:{src:"https://s2.loli.net/2023/04/04/WPdMIrlTYtmgLbU.png",alt:"image-20210601164659462"}})])])}),[],!1,null,null,null);s.default=r.exports}}]);