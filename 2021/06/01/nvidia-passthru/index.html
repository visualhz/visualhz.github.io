<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vSphere6.5+gpu passthru+centos7+nvidia driver | Visual Blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="
在vSphere中配置显卡直通，ESXI机器将需要进入维护模式并重新引导
image-20210601153252871
2.虚拟机配置
配置虚拟机前，请先查看GPU兼容性列表（[GPU直通兼容性查询](https://www.vmware.c ...">
    
    <link rel="preload" href="/assets/css/0.styles.82ff4c1c.css" as="style"><link rel="preload" href="/assets/js/app.777205f3.js" as="script"><link rel="preload" href="/assets/js/6.6fba7d4b.js" as="script"><link rel="preload" href="/assets/js/3.f3e7d945.js" as="script"><link rel="preload" href="/assets/js/12.b328844a.js" as="script"><link rel="prefetch" href="/assets/js/10.d64e7811.js"><link rel="prefetch" href="/assets/js/11.534b8893.js"><link rel="prefetch" href="/assets/js/4.30c48a05.js"><link rel="prefetch" href="/assets/js/5.4f7aad98.js"><link rel="prefetch" href="/assets/js/7.3edf8799.js"><link rel="prefetch" href="/assets/js/8.b386d97d.js"><link rel="prefetch" href="/assets/js/9.7765431c.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.ac365ac7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.82ff4c1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Visual Blog </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Visual Blog </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        vSphere6.5+gpu passthru+centos7+nvidia driver
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">visual</span> <!----></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-06-01T00:00:00.000Z">
      Tue Jun 01 2021
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/运维" data-v-42ccfcd5><span data-v-42ccfcd5>运维</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/vSphere" data-v-42ccfcd5><span data-v-42ccfcd5>vSphere</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/gpu" data-v-42ccfcd5><span data-v-42ccfcd5>gpu</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="_1-vsphere配置gpu直通"><a href="#_1-vsphere配置gpu直通" class="header-anchor">#</a> 1.vSphere配置gpu直通</h2> <p>在vSphere中配置显卡直通，ESXI机器将需要进入维护模式并重新引导</p> <p><img src="https://s2.loli.net/2023/04/04/ko6F7YzJhy2Guj4.png" alt="image-20210601153252871"></p> <hr> <h2 id="_2-虚拟机配置"><a href="#_2-虚拟机配置" class="header-anchor">#</a> 2.虚拟机配置</h2> <p>配置虚拟机前，请先查看GPU兼容性列表（<a href="https://www.vmware.com/resources/compatibility/search.php?deviceCategory=sptg" target="_blank" rel="noopener noreferrer">GPU直通兼容性查询<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <p>创建虚拟机，系统选择为centos7，其中<strong>最小内存为GPU显存总大小的1.5倍</strong>(如此处使用GPU为P100，其显存为16GB，则最小内存大小为24GB)</p> <p>添加新PCI设备，并选择gpu设备进行添加，注意勾选<strong>预留所有客户机内存(全部锁定)</strong></p> <p><img src="https://s2.loli.net/2023/04/04/b9aJefK87TPNpuI.png" alt="image-20210601153545092"></p> <p>依据<a href="https://docs.vmware.com/cn/VMware-vSphere-Bitfusion/3.0/Install-Guide/GUID-2005A8C6-4FDC-46DF-BB6B-989F6E91F3E2.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <ul><li>如果 GPU 需要 16 GB 或更多的内存映射，请在 ESXi 主机的 BIOS 设置中为 GPU 启用直通（通常情况下，设置的名称为 Above 4G decoding、Memory mapped I/O above 4GB 或 PCI 64-bit resource handing above 4G）</li> <li>在虚拟机的引导选项中启用 UEFI 或 EFI</li></ul> <p><img src="https://s2.loli.net/2023/04/04/ku4KT7VpFrhafWe.png" alt="image-20210601155502259"></p> <p>在高级设置中为虚拟机添加参数：</p> <ul><li><p><code>hypervisor.cpuid.v0 = FALSE</code>（不添加此参数可能会导致驱动安装后找不到显卡）</p></li> <li><p><code>pciPassthru.use64bitMMIO = TRUE</code>（不添加此参数可能导致虚拟机无法开机或开机黑屏）</p></li> <li><p><code>pciPassthru.64bitMMIOSizeGB = 48</code>（以P100为例，此处应当填写16即可）</p> <p><img src="https://s2.loli.net/2023/04/04/LBH76MmNJtR5kDu.png" alt="image-20210601162211405"></p></li></ul> <p>其中<code>pciPassthru.64bitMMIOSizeGB</code>的数值取决于GPU显存的总和，具体来说</p> <ul><li>两个16G显存GPU，2 x 16 GB = 32，将 32 GB 向上舍入到下一个 2 次幂，则数值应当为 64 GB</li> <li>三个16G显存GPU，3 x 16 GB = 48，将 48 GB 向上舍入到下一个 2 次幂，则数值应当为 64 GB</li></ul> <p>虚拟机开机后，正常进行系统的安装，此处安装为centos7（gnome）</p> <hr> <h2 id="_3-驱动安装"><a href="#_3-驱动安装" class="header-anchor">#</a> 3.驱动安装</h2> <h3 id="_3-1确认gpu设备存在"><a href="#_3-1确认gpu设备存在" class="header-anchor">#</a> 3.1确认gpu设备存在</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>lspci <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> nvidia
</code></pre></div><p><img src="https://s2.loli.net/2023/04/04/kEpldyOi2V1Bfoz.png" alt="image-20210601162926014"></p> <h3 id="_3-2配置yum镜像源"><a href="#_3-2配置yum镜像源" class="header-anchor">#</a> 3.2配置yum镜像源</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">cp</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
<span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum clean all
yum makecache
</code></pre></div><h3 id="_3-3依赖环境安装"><a href="#_3-3依赖环境安装" class="header-anchor">#</a> 3.3依赖环境安装</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> kernel-devel gcc <span class="token parameter variable">-y</span>
</code></pre></div><h3 id="_3-4检查内核版本和源码版本是否一致"><a href="#_3-4检查内核版本和源码版本是否一致" class="header-anchor">#</a> 3.4检查内核版本和源码版本是否一致</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">ls</span> /boot <span class="token operator">|</span> <span class="token function">grep</span> vmlinu
<span class="token function">rpm</span> <span class="token parameter variable">-aq</span> <span class="token operator">|</span> <span class="token function">grep</span> kernel-devel
</code></pre></div><p><img src="https://s2.loli.net/2023/04/04/ZFryT6mUdnbsNXw.png" alt="image-20210601163415060"></p> <h3 id="_3-5屏蔽系统自带的nouveau"><a href="#_3-5屏蔽系统自带的nouveau" class="header-anchor">#</a> 3.5屏蔽系统自带的nouveau</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">vim</span> /lib/modprobe.d/dist-blacklist.conf
<span class="token comment"># 注释nvidiafb:</span>
<span class="token comment">#blacklist nvidiafb</span>
<span class="token comment"># 并添加语句：</span>
blacklist nouveau
options nouveau <span class="token assign-left variable">modeset</span><span class="token operator">=</span><span class="token number">0</span>
</code></pre></div><p><img src="https://s2.loli.net/2023/04/04/oEIskcHXzauG3ep.png" alt="image-20210601163554291"></p> <h3 id="_3-6重建initramfs-image"><a href="#_3-6重建initramfs-image" class="header-anchor">#</a> 3.6重建initramfs image</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mv</span> /boot/initramfs-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">)</span></span>.img /boot/initramfs-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">)</span></span>.img.bak
dracut /boot/initramfs-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">)</span></span>.img <span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">)</span></span>
</code></pre></div><h3 id="_3-7验证准备完成"><a href="#_3-7验证准备完成" class="header-anchor">#</a> 3.7验证准备完成</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">#修改运行级别为文本模式</span>
systemctl set-default multi-user.target
<span class="token comment">#重新启动</span>
<span class="token function">reboot</span>
<span class="token comment">#验证是否已屏蔽系统驱动</span>
lsmod <span class="token operator">|</span> <span class="token function">grep</span> nouveau
</code></pre></div><p><img src="https://s2.loli.net/2023/04/04/DCqJjV7uOzIG3T6.png" alt="image-20210601164107618"></p> <h3 id="_3-8nvidia官网下载驱动"><a href="#_3-8nvidia官网下载驱动" class="header-anchor">#</a> 3.8nvidia官网下载驱动</h3> <p><a href="https://www.nvidia.cn/Download/index.aspx?lang=cn" target="_blank" rel="noopener noreferrer">NVIDIA驱动程序下载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://s2.loli.net/2023/04/04/JnBdGukI2pCDW3F.png" alt="image-20210601164239105"></p> <h3 id="_3-9安装驱动"><a href="#_3-9安装驱动" class="header-anchor">#</a> 3.9安装驱动</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">chmod</span> +x NVIDIA-Linux-x86_64-460.73.01.run
./NVIDIA-Linux-x86_64-460.73.01.run --kernel-source-path<span class="token operator">=</span>/usr/src/kernels/3.10.0-1160.25.1.el7.x86_64/ --no-opengl-files <span class="token parameter variable">-k</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-r</span><span class="token variable">)</span></span>
</code></pre></div><p><strong>注意安装过程中提示是否修改X config，选择否</strong>（选择是将会导致桌面无法显示）</p> <h3 id="_3-10验证安装成功"><a href="#_3-10验证安装成功" class="header-anchor">#</a> 3.10验证安装成功</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>nvidia-smi
</code></pre></div><p><img src="https://s2.loli.net/2023/04/04/WPdMIrlTYtmgLbU.png" alt="image-20210601164659462"></p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1-vsphere配置gpu直通" title="1.vSphere配置gpu直通">1.vSphere配置gpu直通</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2-虚拟机配置" title="2.虚拟机配置">2.虚拟机配置</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3-驱动安装" title="3.驱动安装">3.驱动安装</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-1确认gpu设备存在" title="3.1确认gpu设备存在">3.1确认gpu设备存在</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-2配置yum镜像源" title="3.2配置yum镜像源">3.2配置yum镜像源</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-3依赖环境安装" title="3.3依赖环境安装">3.3依赖环境安装</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-4检查内核版本和源码版本是否一致" title="3.4检查内核版本和源码版本是否一致">3.4检查内核版本和源码版本是否一致</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-5屏蔽系统自带的nouveau" title="3.5屏蔽系统自带的nouveau">3.5屏蔽系统自带的nouveau</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-6重建initramfs-image" title="3.6重建initramfs image">3.6重建initramfs image</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-7验证准备完成" title="3.7验证准备完成">3.7验证准备完成</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-8nvidia官网下载驱动" title="3.8nvidia官网下载驱动">3.8nvidia官网下载驱动</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-9安装驱动" title="3.9安装驱动">3.9安装驱动</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-10验证安装成功" title="3.10验证安装成功">3.10验证安装成功</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.777205f3.js" defer></script><script src="/assets/js/6.6fba7d4b.js" defer></script><script src="/assets/js/3.f3e7d945.js" defer></script><script src="/assets/js/12.b328844a.js" defer></script>
  </body>
</html>
